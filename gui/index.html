<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt videos downloader</title>
    <style>
        *{
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        body{
            background-color: #fff;
        }
        /* layout style */
        .container{
            display:flex;
            flex-direction:column;
            gap:2rem;
        }
        .header{
            padding: 0.6rem 1.2rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #4e5a87;
        }
        .title{
            display: flex;
            gap:10px;
            align-items: center;
        }
        .main{
            display: flex;
            flex-direction:column;
            align-items: center;
            gap:1rem;
        }
        .choices{
            margin-top:2rem;
            display:flex;
            width:80%;
        }
        .videos,.audios{
            width:50%;
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        .btn_container div:first-child{
            height:5px;
            background:#5cb85c;
            width:80%;
            margin-bottom:1rem;
            margin-top:1rem;
        }
        .btn_container{
            width:100%;
            display:flex;
            flex-direction:column;
            align-items:center;
        }

        /* components styles */
        [class^="btn"]{
            cursor:pointer;
            padding:0.6rem 1.2rem;
            border:none;
            border-radius:5px;
        }
        .btn-red{
            background:red;
            color:white;
        }
        .btn-blue{
            background:blue;
            color:white;
        }
        .icon{
            width: 25px;
            height: 25px;
            fill: white;
        }
        .icon:hover{
            opacity:0.8;
            cursor:pointer;
        }
        .danger{
            background:red;
            border-radius:50%;
        }
        .title{
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }
        .url{
            width: 80%;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
        }
        .thumbnail{
            object-fit: contain;
            width: 80%;
        }
        .hidden_elements{
            display: none;
        }
        .btn{
            color:white;
            width: 100px;
            padding: 0.6rem 1.2rem;
            font-weigh: bold;
            margin: 0 auto;
        }
        .btn-green{
            background: #5cb85c;
        }
        .btn:hover{
            opacity:0.8;
            cursor:pointer;
        }
        .error-message{
            color:red;
        }
        .video-title{
            color:green;
        }
        .custom-control-label {
            cursor: pointer;
        }
        .cap-opt-1 {
            display: inline-block;
            min-width: 50px;
        }
        .custom-control-input:checked ~ .custom-control-label::before {
            color: #fff;
            border-color: #59a9f7;
            background-color: #59a9f7;
        }
        .loader-wrapper {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(26, 26, 26, 0.95);
            z-index: 1000;
            animation: fadeOut 2s ease 2s forwards;
          }
          .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #444;
            border-top-color: #00f7ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
          }
          .loading-text {
            color: #aaa;
            font-size: 1.2rem;
            opacity: 0;
            animation: fadeInOut 2s ease-in-out infinite;
          }
          /* Animations */
          @keyframes spin {
            to {
              transform: rotate(360deg);
            }
          }
          @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
          }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <p class="title">
                <svg class="icon info" id="info" xmlns="http://www.w3.org/2000/svg" id="Filled" viewBox="0 0 24 24" width="512" height="512"><path d="M12,24A12,12,0,1,0,0,12,12.013,12.013,0,0,0,12,24ZM12,5a1.5,1.5,0,1,1-1.5,1.5A1.5,1.5,0,0,1,12,5Zm-1,5h1a2,2,0,0,1,2,2v6a1,1,0,0,1-2,0V12H11a1,1,0,0,1,0-2Z"/>
                </svg> YT Stream downloader
            </p>
            <svg class="icon info" id="danger" xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
            </svg>
        </div>
        <div class="main">
            <input class="url" type="url" id="url" required name="url" placeholder="https://www.youtube.com/watch?v=h" />
            <p class="error-message" id="error-message"></p>
            <p class="video-title" id="video-title"></p>
            <img class="thumbnail hidden_elements" id="thumbnail" src="https://d1csarkz8obe9u.cloudfront.net/posterpreviews/youtube-thumbnail-template-design-5fa9cd79a6367f8446a5208e4540a493_screen.jpg?ts=1699135222" alt="this video url" />

            <div class="choices">
                <div class="videos" id="videos">
                </div>
                <div class="audios" id="audios">
                </div>
            </div>
        </div>
        <div class="loader-wrapper" id="loader">
            <div class="spinner"></div>
            <p class="loading-text">Loading...</p>
        </div>
        <div class="btn_container">
            <div></div>
            <button type="button" id="download" class="btn btn-green">Download</button>
        </div>
    </div>
    <!-- hidden eleemnts and popups-->
    <!-- custom confirmation popup-->
    <div id="customConfirm" style="display:none; position:fixed; top:0; left:0; height:100%; width:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:10px; min-width:300px; max-width:350px; display:flex; flex-direction:column; gap:20px; ">
            <h3 id="confirmTitle">Confirm</h3>
            <p id="confirmMessage">Message</p>
            <div>
            <button class="btn btn-blue" id="confirmYes">Yes</button>
            <button class="btn btn-red" id="confirmNo">No</button>
            </div>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById("url");
        const errorMessage = document.getElementById("error-message");
        const eleVideoTitle = document.getElementById("video-title");
        const eleThumbnail = document.getElementById("thumbnail");
        const infoBtn = document.getElementById("info");
        const closeBtn = document.getElementById("danger");
        const downloadBtn = document.getElementById("download");
        const videosEle = document.getElementById("videos");
        const audiosEle = document.getElementById("audios");
        const loaderEle = document.getElementById("loader");
        let timeoutId;

        // video informations
        let thumbnailUrl;
        let videoTitle;


        downloadBtn.addEventListener('click', async () => {
            const itag_video = document.querySelector('input[name="video"]:checked')?.value;
            const itag_audio = document.querySelector('input[name="audio"]:checked')?.value;

            if(!itag_video && !itag_audio){
                confirm("No sound or video stream was chosen!!")
            }
            if(itag_video && !itag_audio){
                const res = await custom_confirm('Confirm Download',"You didn't select any audio streams the video gonna get downloaded without sound ?");
                if(res){
                    loaderEle.style.display = "flex";
                    const file_path = await window.pywebview.api.download_directly(itag_video);
                    if(file_path){
                        confirm("downloaded succefully");
                    }
                    loaderEle.style.display = "none";
                }
            }
            else if(itag_audio && !itag_video){
                const res = await custom_confirm('Confirm Download',"You didn't select any video streams are you sure you want to download only the audio ?");
                if(res){
                    loaderEle.style.display = "flex";
                    const file_path = await window.pywebview.api.download_directly(itag_audio);
                    if(file_path){
                        confirm("downloaded succefully");
                    }
                    loaderEle.style.display = "none";
                }
            }
            else{
                loaderEle.style.display = "flex";
                const video_file_name = 'video.mp4';
                const audio_file_name = 'audio.mp3';
                const file_path_video = await window.pywebview.api.download(itag_video, video_file_name);
                const file_path_audio = await window.pywebview.api.download(itag_audio, audio_file_name);
                const output_file_path = await window.pywebview.api.merge(file_path_video, file_path_audio);
                loaderEle.style.display = "none";
            }
        });


        closeBtn.addEventListener('click',async ()=>{
            const res = await custom_confirm('Closing The App',"are you sure you want to quit the app");
            if(res){
                await window.pywebview.api.close();
            }
        })

        urlInput.addEventListener('input', ()=>{
            errorMessage.textContent = "";

            clearTimeout(timeoutId);
            if(!urlInput.checkValidity()){
                errorMessage.textContent = "Please enter a valid URL";
                eleVideoTitle.textContent = "";
                thumbnailUrl = "";
                eleThumbnail.classList.add("hidden_elements")
            }
            else{
                timeoutId = setTimeout(async ()=>{
                    await set_url(urlInput.value)
                },1000)
            }
        })

        async function set_url(url){
            await window.pywebview.api.set_url(url)
            await retrieve_video_title();
            await retrieve_video_thumbnail()
            const infos = await retrieve_streams_info(); 
            render_videos(infos)
            render_audios(infos)
        }

        async function retrieve_video_title(){
            videoTitle = await window.pywebview.api.retrieve_video_title()
            eleVideoTitle.textContent = videoTitle;
        }

        function render_videos(arr){
            let html = "";
            for (let i=0; i<arr.length; i++){
                if(arr[i]["type"] == "video"){
                    html += `
                        <label class="custom-control-label">
                        <input type="radio" class="custom-control-input" name="video" value="${arr[i]['itag']}" />
                        ${arr[i]['resolution']} | ${arr[i]['size']}M
                        </label>                   
                    `
                }
                
            }
            videosEle.innerHTML = html;
        }

        function render_audios(arr){
            let html = "";
            for (let i=0; i<arr.length; i++){
                if(arr[i]["type"] == "audio"){
                    html += `
                        <label class="custom-control-label">
                        <input type="radio" class="custom-control-input" name="audio" value="${arr[i]['itag']}" />
                        ${arr[i]['abr']}| ${arr[i]['size']}M
                        </label>
                    `
                }
            }
            audiosEle.innerHTML = html;
        }

        async function retrieve_video_thumbnail(){
            thumbnailUrl = await window.pywebview.api.retrieve_thumbnail_url()
            eleThumbnail.src = thumbnailUrl;
            eleThumbnail.classList.remove("hidden_elements")
        }

        async function retrieve_streams_info(){
            info = await window.pywebview.api.retrieve_streams_info()
            return info;
        }


        // global custom functions ex : customConfirm etc...
        function custom_confirm(title, message){
            return new Promise((resolve) => {
                const modal = document.getElementById("customConfirm");
                const titleEle = document.getElementById("confirmTitle");
                const msgEle = document.getElementById("confirmMessage");
                const yesBtn = document.getElementById("confirmYes");
                const noBtn = document.getElementById("confirmNo");

                titleEle.textContent = title;
                msgEle.textContent = message;

                modal.style.display = "flex";
                
                const cleanup = ()=>{
                    modal.style.display = "none";
                    yesBtn.removeEventListener('click',onYes)
                    noBtn.removeEventListener('click',onNo)
                }

                const onYes = ()=>{ cleanup(); resolve(true); };
                const onNo = ()=>{ cleanup(); resolve(false); };

                yesBtn.addEventListener('click', onYes);
                noBtn.addEventListener('click', onNo);
            })
        }
    </script>
</body>
</html>
